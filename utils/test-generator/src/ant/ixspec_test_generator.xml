<?xml version="1.0" encoding="UTF-8"?>
<antlib
    xmlns:if="ant:if"
    xmlns:unless="ant:unless"
    xmlns:ixspec="http://xylarium.org/ns/ant/macros/utils/ixspec">	
	
	<macrodef
		name="create"
		description="Generate an iXSpec test file."
		uri="http://xylarium.org/ns/ant/macros/utils/ixspec"> 
		
		<attribute name="tests-dir" />
		<attribute name="output-dir" />
		<attribute name="summary" />
		<attribute name="catalogs" default="${resource-resolution.catalog.default}" />
		<attribute name="config" default="${xproc.processor.morgana.config.default}" />
		<attribute name="tmp-dir" default="${base.tmp}" />
		<attribute name="debug-dir" default="${base.debug}" />
		<attribute name="debug" default="${debug}" />
		
		<sequential>
			
						
			<local name="local.xproc-config.available" />
			<available property="local.xproc-config.available" file="@{config}" type="file" />
			<fail message="XProc config file not found: @{config}" unless:true="${local.xproc-config.available}" />
			
			<local name="local.xproc-home" />
			<dirname property="local.xproc-home" file="${xproc.processor.morgana}" />
			
			<local name="local.xproc-lib" />
			<property name="local.xproc-lib" location="${local.xproc-home}/MorganaXProc-IIIse_lib" />
			
			<local name="local.xproc-lib.available" />
			<available property="local.xproc-lib.available" file="${local.xproc-lib}" type="dir" />
			<fail message="XProc library not found: ${local.xproc-lib}" unless:true="${local.xproc-lib.available}" />
									
			<local name="local.uri.tests-dir" />			
			<makeurl property="local.uri.tests-dir" file="@{tests-dir}" validate="true" />
			
			<local name="local.uri.output-dir" />			
			<makeurl property="local.uri.output-dir" file="@{output-dir}" validate="false" />
			
			<local name="local.uri.tmp-dir" />			
			<makeurl property="local.uri.tmp-dir" file="@{tmp-dir}" validate="false" />
			
			<local name="local.uri.debug-dir" />
			<makeurl property="local.uri.debug-dir" file="@{debug-dir}" validate="false" />	
		
			<echo message="catalogs: @{catalogs}" />
			
			<java classname="com.xml_project.morganaxproc3.XProcEngine">
				<classpath>
					<pathelement location="${local.xproc-lib}/*" />
					<pathelement location="${xproc.processor.morgana}" />
					<pathelement location="${xslt.processor.saxon}" />
					<pathelement location="${resource-resolution.resolver.xml-commons}" />
					<pathelement location="${ixml.processor.nine-ml.coffeegrinder}" />
					<pathelement location="${ixml.processor.nine-ml.coffeefilter}" />
					<pathelement location="${java.class.path}" />
				</classpath>

				<arg line="-config=@{config}" />	
				<arg line="${xproc.pipeline.ixspec-test-generator}" />					
				<arg line="-catalogs=@{catalogs}" />					
				<arg line="-output:result=@{summary}" />
				<arg line="-option:tests-dir=${local.uri.tests-dir}" />
				<arg line="-option:output-dir=${local.uri.output-dir}" />
				<arg line="-option:tmp-dir=${local.uri.tmp-dir}" />		
				<arg line="-option:debug-dir=${local.uri.debug-dir}" />		
				<arg line="-option:debug=@{debug}" />				
				<arg line="-cp" />					
			</java>
			
			
		</sequential>		
	</macrodef>		
    
</antlib>