<?xml version="1.0" encoding="UTF-8"?>
<antlib
    xmlns:if="ant:if"
    xmlns:unless="ant:unless"
    xmlns:debug="http://xylarium.org/ns/ant/macros/utils/debug"
    xmlns:file="http://xylarium.org/ns/ant/macros/utils/file"
    xmlns:xml-catalog="http://xylarium.org/ns/ant/macros/utils/xml-catalog"
    xmlns:xspec="http://xylarium.org/ns/ant/macros/utils/xspec"
    xmlns:ixspec="http://xylarium.org/ns/ant/macros/utils/ixspec">	
		
	
	<macrodef name="run"
		description="Run an iXSpec test file."
		uri="http://xylarium.org/ns/ant/macros/utils/ixspec">
		
		<attribute name="source" />
		<attribute name="output-dir" />
		<attribute name="catalogs" default="${xylarium.lib.ixspec.catalog.default}" />    	
		<attribute name="fail-on-error" default="false" />
		<attribute name="tmp-dir" default="${xylarium.dir.tmp}" />
		<attribute name="debug-dir" default="${xylarium.dir.debug}" />
		<attribute name="debug" default="false" />
		
		<sequential>
			
			<debug:macro-start if:true="@{debug}" 
				namespace-uri="http://xylarium.org/ns/ant/macros/utils/ixspec" 
				name="run" 
			/>	
			
			<echo level="debug" message="Source: @{source}" />
			<echo level="debug" message="Output dir: @{output-dir}" />
			<echo level="debug" message="Catalogs: @{catalogs}" />
			<echo level="debug" message="Fail on error: @{fail-on-error}" />
			<echo level="debug" message="Temp dir: @{tmp-dir}" />
			<echo level="debug" message="Debug dir: @{debug-dir}" />
			<echo level="debug" message="Debug: @{debug}" />
			
			
			<local name="local.ixspec-file.suffix" />
			<file:get-suffix 
				file="@{file}"
				property="local.ixspec-file.suffix"
				debug="@{debug}"
			/>
			
			<local name="local.ixspec-file.name-without-extension" />
			<basename property="local.ixspec-file.name-without-extension" file="@{source}" suffix=".${local.ixspec-file.suffix}" /> 
			
			<!--
			<local name="local.ixspec-file.absolute-path" />
			<path id="local.ixspec-file.absolute-path">
				<fileset file="@{file}" />
			</path>
			-->			
			
			<!--
			<pathconvert property="local.ixspec-file.name.original-extension" refid="local.ixspec-file.absolute-path">			
				<chainedmapper>        			
					<regexpmapper from="^.*\.([^\.]*)$" to="\1" handledirsep="true" />
				</chainedmapper>
			</pathconvert>
			-->
			
			<local name="local.xspec-file" />
			<property name="local.xspec-file" location="@{tmp-dir}/${local.ixspec-file.name-without-extension}.xspec" />
			
			<ixspec:to-xspec
				ixspec-file="@{source}"
				result="${local.xspec-file}"
				catalogs="@{catalogs}"
				tmp-dir="@{tmp-dir}"
				debug-dir="@{debug-dir}"
				debug="@{debug}"
			/>
			
			<xspec:run
				file="${local.xspec-file}"
				output-dir="@{output-dir}"
				tmp-dir="@{tmp-dir}"
				catalogs="@{catalogs}"
				fail-on-error="@{fail-on-error}"
				debug="@{debug}"
			/>
			
			<debug:macro-end if:true="@{debug}" 
				namespace-uri="http://xylarium.org/ns/ant/macros/utils/ixspec" 
				name="run" 
			/>	
			
		</sequential>
		
	</macrodef>
	
	
	<macrodef
		name="to-xspec"
		description="Preprocess an iXSpec test file."
		uri="http://xylarium.org/ns/ant/macros/utils/ixspec"> 
		
		<attribute name="ixspec-file" />
		<attribute name="result" />
		<attribute name="catalogs" default="${xylarium.lib.ixspec.processor.catalog.default}" />
		<attribute name="config" default="${xylarium.lib.xproc.processor.config.default}" />
		<attribute name="tmp-dir" default="${xylarium.dir.tmp}" />
		<attribute name="debug-dir" default="${xylarium.dir.debug}" />
		<attribute name="debug" default="false" />
		
		<sequential>
			
			<debug:macro-start if:true="@{debug}" 
				namespace-uri="http://xylarium.org/ns/ant/macros/utils/ixspec" 
				name="to-xspec" 
			/>	
			
			<echo level="debug" message="iXSpec file: @{ixspec-file}" />
			<echo level="debug" message="Result: @{result}" />
			<echo level="debug" message="Catalogs: @{catalogs}" />
			<echo level="debug" message="Config: @{config}" />
			<echo level="debug" message="Temp dir: @{tmp-dir}" />
			<echo level="debug" message="Debug dir: @{debug-dir}" />
			<echo level="debug" message="Debug: @{debug}" />
			
			
			<echo level="info" message="Converting @{ixspec-file} to XSpec" />
			
			<local name="local.ixspec-file.available" />
			<available property="local.ixspec-file.available" file="@{ixspec-file}" type="file" />
			<fail message="iXSpec file not found: @{ixspec-file}" unless:true="${local.ixspec-file.available}" />
						
			<local name="local.xproc-config.available" />
			<available property="local.xproc-config.available" file="@{config}" type="file" />
			<fail message="XProc config file not found: @{config}" unless:true="${local.xproc-config.available}" />
									
			<local name="local.xproc-lib.available" />
			<available property="local.xproc-lib.available" file="${xylarium.lib.xproc.processor.lib}" type="dir" />
			<fail message="XProc library not found: ${xylarium.xproc.processor.lib}" unless:true="${local.xproc-lib.available}" />			

			<local name="local.catalog-list" />
			<xml-catalog:prepend-to-list
				catalog="${xylarium.lib.ixspec.processor.catalog.default}"
				list="@{catalogs}"
				property="local.catalog-list"
				fail-on-error="true"
				debug="@{debug}"
			/>
			
			<echo level="debug" message="Updated catalogs: ${local.catalog-list}" />

			<local name="local.uri.tmp-dir" />			
			<makeurl property="local.uri.tmp-dir" file="@{tmp-dir}" validate="false" />
			
			<local name="local.uri.debug-dir" />
			<makeurl property="local.uri.debug-dir" file="@{debug-dir}" validate="false" />	
		
			
			<java classname="${xylarium.lib.xproc.processor.classname}">
				<classpath>
					<pathelement location="${xylarium.lib.xproc.processor.lib}" />
					<pathelement location="${xylarium.lib.xproc.processor}" />
					<pathelement location="${xylarium.lib.xslt.processor}" />
					<pathelement location="${xylarium.lib.resource-resolution.processor}" />
					<pathelement location="${xylarium.lib.ixml.processor.nine-ml.coffeegrinder}" />
					<pathelement location="${xylarium.lib.ixml.processor.nine-ml.coffeefilter}" />
					<pathelement location="${java.class.path}" />
				</classpath>

				<arg line="-config=@{config}" />	
				<arg line="${xylarium.lib.ixspec.processor.home}/src/xproc/ixspec2xspec.xpl" />					
				<arg line="-catalogs=${local.catalog-list}" />								
				<arg line="-input:source=@{ixspec-file}" />				
				<arg line="-output:result=@{result}" />				
				<arg line="-option:tmp-dir=${local.uri.tmp-dir}" />		
				<arg line="-option:debug-dir=${local.uri.debug-dir}" />		
				<arg line="-option:debug=@{debug}" />				
				<arg line="-cp" />					
			</java>
			
			<debug:macro-end if:true="@{debug}" 
				namespace-uri="http://xylarium.org/ns/ant/macros/utils/ixspec" 
				name="to-xspec" 
			/>	
			
		</sequential>		
	</macrodef>		
    
</antlib>